{"ast":null,"code":"import _asyncToGenerator from \"/home/bachir-uchiwa/Bureau/projet3D/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { RouterModule } from '@angular/router';\nimport { HeaderComponent } from '../../components/header/header.component';\nimport { FooterComponent } from '../../components/footer/footer.component';\nimport { ReactiveFormsModule, FormsModule, Validators } from '@angular/forms';\nimport Swal from 'sweetalert2';\nlet DashboardAgriculteurComponent = class DashboardAgriculteurComponent {\n  constructor(dataService, fb) {\n    this.dataService = dataService;\n    this.fb = fb;\n    // Data\n    this.products = [];\n    this.seeds = [];\n    this.seedOrderQty = {};\n    this.alerts = [];\n    this.currentUser = null;\n    this.uploadedImageCount = 0;\n    this.selectedImages = [];\n    this.cameraActive = false;\n    this.stream = null;\n  }\n  ngOnInit() {\n    const raw = localStorage.getItem('currentUser');\n    this.currentUser = raw ? JSON.parse(raw) : null;\n    // Initialize forms\n    this.productForm = this.fb.group({\n      titre: ['', Validators.required],\n      description: ['', Validators.required],\n      categorie: ['', Validators.required],\n      quantite: ['', [Validators.required, Validators.min(0)]],\n      quantiteMinimale: ['', [Validators.required, Validators.min(0)]],\n      // 'prix' removed from form: we compute total price from quantite * prixParUnite\n      prixParUnite: ['', [Validators.required, Validators.min(0)]],\n      unite: ['', Validators.required],\n      localisation: ['', Validators.required],\n      publicationType: ['product', Validators.required],\n      periodeApproximativeDebut: [''],\n      periodeApproximativeFin: ['']\n    });\n    this.bankForm = this.fb.group({\n      bankName: [''],\n      accountNumber: ['']\n    });\n    this.loadInitial();\n  }\n  loadInitial() {\n    if (!this.currentUser) return;\n    // Load user's products\n    this.dataService.getProductsByUser(this.currentUser.id).subscribe(list => this.products = list || []);\n    // Load seeds catalog\n    this.dataService.getSeedsCatalog().subscribe(list => {\n      this.seeds = list || [];\n      this.seeds.forEach(s => this.seedOrderQty[s.id] = 1);\n    });\n    // Load alerts filtered by region\n    if (this.currentUser.region) {\n      this.dataService.getAlertsByRegion(this.currentUser.region).subscribe(list => this.alerts = list || []);\n    }\n    // Bank info prefill\n    if (this.currentUser.bankAccount) {\n      this.bankForm.patchValue(this.currentUser.bankAccount);\n    }\n  }\n  // Handle image file selection\n  onImagesSelected(event) {\n    this.selectedImages = Array.from(event.target.files || []);\n    this.uploadedImageCount = this.selectedImages.length;\n  }\n  // Start camera\n  startCamera() {\n    this.cameraActive = true;\n    navigator.mediaDevices.getUserMedia({\n      video: {\n        facingMode: 'environment'\n      }\n    }).then(mediaStream => {\n      this.stream = mediaStream;\n      setTimeout(() => {\n        const video = document.getElementById('cameraVideo');\n        if (video) video.srcObject = mediaStream;\n      }, 100);\n    }).catch(err => {\n      console.error('Camera error:', err);\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur d\\'accès à la caméra',\n        text: 'Vérifiez les permissions de votre navigateur',\n        confirmButtonColor: '#22c55e'\n      });\n      this.cameraActive = false;\n    });\n  }\n  // Capture photo from camera\n  capturePhoto() {\n    const video = document.getElementById('cameraVideo');\n    const canvas = document.getElementById('cameraCanvas');\n    if (!video || !canvas) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    canvas.width = video.videoWidth;\n    canvas.height = video.videoHeight;\n    ctx.drawImage(video, 0, 0);\n    canvas.toBlob(blob => {\n      if (blob) {\n        const file = new File([blob], `photo-${Date.now()}.jpg`, {\n          type: 'image/jpeg'\n        });\n        this.selectedImages.push(file);\n        this.uploadedImageCount = this.selectedImages.length;\n      }\n    }, 'image/jpeg', 0.95);\n  }\n  // Stop camera\n  stopCamera() {\n    this.cameraActive = false;\n    if (this.stream) {\n      this.stream.getTracks().forEach(track => track.stop());\n      this.stream = null;\n    }\n  }\n  // Publish product\n  publishProduct() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (!_this.productForm.valid || !_this.currentUser) {\n        // Identify which controls are invalid to help debugging\n        const invalid = Object.keys(_this.productForm.controls).filter(k => _this.productForm.get(k)?.invalid);\n        console.warn('Product form invalid controls:', invalid);\n        const names = invalid.length ? invalid.join(', ') : 'inconnus';\n        Swal.fire({\n          icon: 'warning',\n          title: 'Champs obligatoires manquants',\n          text: 'Veuillez remplir tous les champs obligatoires. Champs invalides: ' + names,\n          confirmButtonColor: '#22c55e'\n        });\n        return;\n      }\n      // ⚠️ Check that at least 1 image is selected (MANDATORY)\n      if (_this.selectedImages.length === 0) {\n        Swal.fire({\n          icon: 'warning',\n          title: 'Image obligatoire',\n          text: 'Veuillez importer une photo ou en photographier une avant de publier le produit.',\n          confirmButtonColor: '#22c55e'\n        });\n        console.warn('Image upload required but none selected');\n        return;\n      }\n      // Upload images directly to Cloudinary (with unsigned preset)\n      try {\n        let uploadedUrls = [];\n        if (_this.selectedImages.length) {\n          const cloudName = 'djha1kqvu';\n          const uploadPreset = 'senteranga_products'; // You'll need to create this preset in Cloudinary\n          const uploadUrls = yield Promise.all(_this.selectedImages.map(/*#__PURE__*/function () {\n            var _ref = _asyncToGenerator(function* (file, index) {\n              const formData = new FormData();\n              formData.append('file', file);\n              formData.append('upload_preset', uploadPreset);\n              formData.append('folder', 'senteranga_products');\n              const response = yield fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {\n                method: 'POST',\n                body: formData\n              });\n              if (!response.ok) {\n                throw new Error(`Cloudinary upload failed: ${response.statusText}`);\n              }\n              const result = yield response.json();\n              return result.secure_url;\n            });\n            return function (_x, _x2) {\n              return _ref.apply(this, arguments);\n            };\n          }()));\n          uploadedUrls = uploadUrls;\n        }\n        // compute total price from quantity and price per unit\n        const q = parseFloat(_this.productForm.value.quantite) || 0;\n        const ppu = parseFloat(_this.productForm.value.prixParUnite) || 0;\n        const totalPrice = q * ppu;\n        const isAnnouncement = _this.productForm.value.publicationType === 'announcement';\n        // Validate announcement dates if it's an announcement\n        if (isAnnouncement) {\n          const startDate = _this.productForm.value.periodeApproximativeDebut;\n          const endDate = _this.productForm.value.periodeApproximativeFin;\n          if (!startDate || !endDate) {\n            Swal.fire({\n              icon: 'warning',\n              title: 'Périodes requises',\n              text: 'Veuillez définir la période approximative de disponibilité pour l\\'annonce.',\n              confirmButtonColor: '#22c55e'\n            });\n            return;\n          }\n          if (new Date(startDate) >= new Date(endDate)) {\n            Swal.fire({\n              icon: 'warning',\n              title: 'Périodes invalides',\n              text: 'La période de fin doit être postérieure à la période de début.',\n              confirmButtonColor: '#22c55e'\n            });\n            return;\n          }\n        }\n        const product = {\n          id: `prod-${Date.now()}`,\n          agriculteurId: _this.currentUser.id,\n          titre: _this.productForm.value.titre,\n          description: _this.productForm.value.description,\n          categorie: _this.productForm.value.categorie,\n          quantite: q,\n          quantiteMinimale: parseFloat(_this.productForm.value.quantiteMinimale),\n          prix: totalPrice,\n          prixParUnite: ppu,\n          unite: _this.productForm.value.unite,\n          localisation: _this.productForm.value.localisation,\n          images: uploadedUrls,\n          statutValidation: 'en_attente',\n          statutDisponibilite: isAnnouncement ? 'reservé' : 'disponible',\n          datePublication: new Date().toISOString(),\n          dateMaj: new Date().toISOString(),\n          // Announcement fields\n          isAnnonce: isAnnouncement,\n          periodeApproximativeDebut: isAnnouncement ? _this.productForm.value.periodeApproximativeDebut : undefined,\n          periodeApproximativeFin: isAnnouncement ? _this.productForm.value.periodeApproximativeFin : undefined,\n          statutAnnonce: isAnnouncement ? 'en_attente' : undefined\n        };\n        _this.dataService.createProduct(product).subscribe({\n          next: created => {\n            _this.products.unshift(created);\n            const message = isAnnouncement ? 'Votre annonce est en attente de validation par l\\'administration. Elle sera disponible selon les dates définies une fois validée.' : 'Votre produit est en attente de validation par l\\'administration.';\n            Swal.fire({\n              icon: 'success',\n              title: isAnnouncement ? 'Annonce publiée !' : 'Produit publié !',\n              text: message,\n              confirmButtonColor: '#22c55e'\n            });\n            _this.resetProductForm();\n          },\n          error: err => {\n            console.error('Error publishing product', err);\n            Swal.fire({\n              icon: 'error',\n              title: 'Erreur de publication',\n              text: 'Une erreur s\\'est produite lors de la publication du produit.',\n              confirmButtonColor: '#22c55e'\n            });\n          }\n        });\n      } catch (err) {\n        console.error('Image upload failed', err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Échec de l\\'upload',\n          text: 'Une erreur s\\'est produite lors de l\\'upload des images.',\n          confirmButtonColor: '#22c55e'\n        });\n      }\n    })();\n  }\n  // Reset product form and image selection\n  resetProductForm() {\n    this.productForm.reset();\n    this.selectedImages = [];\n    this.uploadedImageCount = 0;\n    this.stopCamera();\n  }\n  // Convert files to base64\n  convertImagesToBase64(files) {\n    return Promise.all(files.map(file => {\n      return new Promise(resolve => {\n        const reader = new FileReader();\n        reader.onload = () => {\n          resolve(reader.result);\n        };\n        reader.readAsDataURL(file);\n      });\n    }));\n  }\n  // Bank account save\n  saveBankAccount() {\n    if (!this.currentUser) return;\n    const bank = this.bankForm.value;\n    const payload = {\n      bankName: bank.bankName || '',\n      accountNumber: bank.accountNumber || ''\n    };\n    this.dataService.updateUserBankAccount(this.currentUser.id, payload).subscribe({\n      next: u => {\n        this.currentUser = u;\n        localStorage.setItem('currentUser', JSON.stringify(u));\n        Swal.fire({\n          icon: 'success',\n          title: 'Succès',\n          text: 'Compte bancaire enregistré avec succès',\n          confirmButtonColor: '#22c55e'\n        });\n      },\n      error: err => {\n        console.error(err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Erreur lors de l\\'enregistrement du compte bancaire',\n          confirmButtonColor: '#22c55e'\n        });\n      }\n    });\n  }\n  // Order seed\n  orderSeed(seed) {\n    if (!this.currentUser) return;\n    const qty = this.seedOrderQty[seed.id] || 1;\n    const order = {\n      id: `order-${Date.now()}`,\n      userId: this.currentUser.id,\n      seedId: seed.id,\n      seedName: seed.name,\n      quantity: qty,\n      total: (seed.price || 0) * qty,\n      status: 'paid',\n      createdAt: new Date().toISOString()\n    };\n    this.dataService.createSeedOrder(order).subscribe({\n      next: res => {\n        Swal.fire({\n          icon: 'success',\n          title: 'Commande passée',\n          text: `Commande passée: ${order.seedName} x${qty}`,\n          confirmButtonColor: '#22c55e'\n        });\n      },\n      error: err => {\n        console.error(err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur de commande',\n          text: 'Une erreur s\\'est produite lors de la commande',\n          confirmButtonColor: '#22c55e'\n        });\n      }\n    });\n  }\n};\nDashboardAgriculteurComponent = __decorate([Component({\n  selector: 'app-dashboard-agriculteur',\n  standalone: true,\n  imports: [CommonModule, RouterModule, HeaderComponent, FooterComponent, ReactiveFormsModule, FormsModule],\n  templateUrl: './dashboard-agriculteur.component.html',\n  styleUrls: ['./dashboard-agriculteur.component.css']\n})], DashboardAgriculteurComponent);\nexport { DashboardAgriculteurComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}