{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { HeaderComponent } from '../../components/header/header.component';\nimport { FooterComponent } from '../../components/footer/footer.component';\nimport { FormsModule } from '@angular/forms';\nimport Swal from 'sweetalert2';\nlet DashboardAdminComponent = class DashboardAdminComponent {\n  constructor(dataService) {\n    this.dataService = dataService;\n    this.users = [];\n    this.userMap = {}; // map userId to full name\n    this.loading = false;\n    this.errorMessage = '';\n    // Products validation\n    this.pendingProducts = [];\n    this.selectedReason = {};\n    // Announcements validation\n    this.pendingAnnouncements = [];\n    this.toastMessage = '';\n    this.toastType = 'success';\n    this.showToast = false;\n  }\n  ngOnInit() {\n    this.loadUsers();\n    this.loadPendingProducts();\n    this.loadPendingAnnouncements();\n  }\n  showToastMessage(message, type = 'success') {\n    this.toastMessage = message;\n    this.toastType = type;\n    this.showToast = true;\n    setTimeout(() => {\n      this.showToast = false;\n    }, 3000);\n  }\n  loadUsers() {\n    this.loading = true;\n    this.errorMessage = '';\n    this.dataService.getTestUsers().subscribe({\n      next: users => {\n        // Show all users except the current admin\n        const currentUser = localStorage.getItem('currentUser');\n        const currentAdminId = currentUser ? JSON.parse(currentUser).id : null;\n        this.users = users.filter(u => u.id !== currentAdminId && u.userType !== 'admin');\n        // Build user map for quick lookups\n        users.forEach(u => {\n          this.userMap[u.id] = `${u.firstName} ${u.lastName}`;\n        });\n        this.loading = false;\n      },\n      error: err => {\n        console.error('Error loading users:', err);\n        this.errorMessage = 'Erreur lors du chargement des utilisateurs';\n        this.loading = false;\n      }\n    });\n  }\n  // --- Products ---\n  loadPendingProducts() {\n    this.dataService.getAllProducts().subscribe({\n      next: list => {\n        this.pendingProducts = (list || []).filter(p => p.statutValidation === 'en_attente' && !p.isAnnonce);\n      },\n      error: err => {\n        console.error('Error loading products', err);\n      }\n    });\n  }\n  // --- Announcements ---\n  loadPendingAnnouncements() {\n    this.dataService.getAllProducts().subscribe({\n      next: list => {\n        this.pendingAnnouncements = (list || []).filter(p => p.isAnnonce && p.statutAnnonce === 'en_attente');\n      },\n      error: err => {\n        console.error('Error loading announcements', err);\n      }\n    });\n  }\n  approveAnnouncement(announcement) {\n    const updatedAnnouncement = {\n      ...announcement,\n      statutAnnonce: 'validee',\n      statutValidation: 'validé',\n      statutDisponibilite: 'disponible'\n    };\n    this.dataService.updateProduct(updatedAnnouncement).subscribe({\n      next: result => {\n        // Create notification for the farmer\n        this.dataService.createNotification({\n          id: `notif-${Date.now()}`,\n          userId: announcement.agriculteurId,\n          type: 'announcement',\n          title: 'Annonce approuvée',\n          message: `Votre annonce « ${announcement.titre} » a été approuvée et sera disponible approximativement de ${announcement.periodeApproximativeDebut} à ${announcement.periodeApproximativeFin}.`,\n          date: new Date().toISOString(),\n          read: false,\n          createdAt: new Date().toISOString()\n        }).subscribe(() => {\n          this.showToastMessage(`Annonce « ${announcement.titre} » approuvée ✓`);\n          this.loadPendingAnnouncements();\n        });\n      },\n      error: err => {\n        console.error('Approve announcement failed', err);\n        this.showToastMessage('Erreur lors de l\\'approbation de l\\'annonce', 'error');\n      }\n    });\n  }\n  rejectAnnouncement(announcement) {\n    const updatedAnnouncement = {\n      ...announcement,\n      statutAnnonce: 'rejetee',\n      statutValidation: 'rejeté'\n    };\n    this.dataService.updateProduct(updatedAnnouncement).subscribe({\n      next: result => {\n        // Create notification for the farmer\n        this.dataService.createNotification({\n          id: `notif-${Date.now()}`,\n          userId: announcement.agriculteurId,\n          type: 'announcement',\n          title: 'Annonce rejetée',\n          message: `Votre annonce « ${announcement.titre} » a été rejetée par l'administration.`,\n          date: new Date().toISOString(),\n          read: false,\n          createdAt: new Date().toISOString()\n        }).subscribe(() => {\n          this.showToastMessage(`Annonce « ${announcement.titre} » rejetée ✗`);\n          this.loadPendingAnnouncements();\n        });\n      },\n      error: err => {\n        console.error('Reject announcement failed', err);\n        this.showToastMessage('Erreur lors du rejet de l\\'annonce', 'error');\n      }\n    });\n  }\n  approve(user) {\n    const updated = {\n      ...user,\n      isValidated: true,\n      validationStatus: 'approved'\n    };\n    this.dataService.updateUser(updated).subscribe({\n      next: result => {\n        // Create notification\n        this.dataService.createNotification({\n          id: `notif-${Date.now()}`,\n          userId: updated.id,\n          type: 'validation',\n          title: 'Compte approuvé',\n          message: 'Votre compte a été approuvé par l\\'administration SENTERANGA. Vous pouvez maintenant vous connecter.',\n          date: new Date().toISOString(),\n          read: false,\n          createdAt: new Date().toISOString()\n        }).subscribe({\n          next: () => {\n            Swal.fire({\n              icon: 'success',\n              title: 'Utilisateur approuvé',\n              text: `${updated.firstName} ${updated.lastName} a été approuvé(e)`,\n              confirmButtonColor: '#22c55e'\n            });\n            this.loadUsers();\n          },\n          error: () => {\n            Swal.fire({\n              icon: 'warning',\n              title: 'Utilisateur approuvé',\n              text: 'Utilisateur approuvé, mais erreur lors de la notification',\n              confirmButtonColor: '#22c55e'\n            });\n            this.loadUsers();\n          }\n        });\n      },\n      error: err => {\n        console.error('Error updating user:', err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur d\\'approbation',\n          text: 'Une erreur s\\'est produite lors de l\\'approbation',\n          confirmButtonColor: '#22c55e'\n        });\n      }\n    });\n  }\n  reject(user) {\n    const updated = {\n      ...user,\n      isValidated: false,\n      validationStatus: 'rejected'\n    };\n    this.dataService.updateUser(updated).subscribe({\n      next: result => {\n        this.dataService.createNotification({\n          id: `notif-${Date.now()}`,\n          userId: updated.id,\n          type: 'validation',\n          title: 'Compte rejeté',\n          message: 'Votre demande d\\'inscription a été rejetée. Contactez le support pour plus d\\'informations.',\n          date: new Date().toISOString(),\n          read: false,\n          createdAt: new Date().toISOString()\n        }).subscribe({\n          next: () => {\n            Swal.fire({\n              icon: 'success',\n              title: 'Utilisateur rejeté',\n              text: `${updated.firstName} ${updated.lastName} a été rejeté(e)`,\n              confirmButtonColor: '#22c55e'\n            });\n            this.loadUsers();\n          },\n          error: () => {\n            Swal.fire({\n              icon: 'warning',\n              title: 'Utilisateur rejeté',\n              text: 'Utilisateur rejeté, mais erreur lors de la notification',\n              confirmButtonColor: '#22c55e'\n            });\n            this.loadUsers();\n          }\n        });\n      },\n      error: err => {\n        console.error('Error updating user:', err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur de rejet',\n          text: 'Une erreur s\\'est produite lors du rejet',\n          confirmButtonColor: '#22c55e'\n        });\n      }\n    });\n  }\n  approveProduct(product) {\n    this.dataService.updateProductStatus(product.id, 'validé').subscribe({\n      next: updated => {\n        const note = {\n          id: `note-${Date.now()}`,\n          userId: product.agriculteurId,\n          title: 'Produit validé',\n          message: `Votre produit « ${product.titre} » a été validé et est maintenant visible sur le marché.`,\n          createdAt: new Date().toISOString(),\n          read: false\n        };\n        this.dataService.createNotification(note).subscribe(() => {\n          this.showToastMessage(`Produit « ${product.titre} » validé ✓`);\n          this.loadPendingProducts();\n        });\n      },\n      error: err => {\n        console.error('Approve product failed', err);\n        this.showToastMessage('Erreur lors de la validation', 'error');\n      }\n    });\n  }\n  rejectProduct(product) {\n    const reason = this.selectedReason[product.id] || '';\n    if (!reason.trim()) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Motif requis',\n        text: 'Veuillez saisir un motif de refus.',\n        confirmButtonColor: '#22c55e'\n      });\n      return;\n    }\n    this.dataService.updateProductStatus(product.id, 'rejeté').subscribe({\n      next: updated => {\n        const note = {\n          id: `note-${Date.now()}`,\n          userId: product.agriculteurId,\n          title: 'Produit rejeté',\n          message: `Votre produit « ${product.titre} » a été rejeté. Motif: ${reason}`,\n          createdAt: new Date().toISOString(),\n          read: false\n        };\n        this.dataService.createNotification(note).subscribe(() => {\n          this.showToastMessage(`Produit « ${product.titre} » rejeté ✗`);\n          this.loadPendingProducts();\n        });\n      },\n      error: err => {\n        console.error('Reject product failed', err);\n        this.showToastMessage('Erreur lors du refus', 'error');\n      }\n    });\n  }\n};\nDashboardAdminComponent = __decorate([Component({\n  selector: 'app-dashboard-admin',\n  standalone: true,\n  imports: [CommonModule, HeaderComponent, FooterComponent, FormsModule],\n  templateUrl: './dashboard-admin.component.html'\n})], DashboardAdminComponent);\nexport { DashboardAdminComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}