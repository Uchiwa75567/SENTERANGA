{"ast":null,"code":"import { of } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport let DataService = /*#__PURE__*/(() => {\n  class DataService {\n    constructor(http) {\n      this.http = http;\n      this.apiUrl = 'http://localhost:3003';\n    }\n    getRegions() {\n      return this.http.get(`${this.apiUrl}/regions`);\n    }\n    updateUser(user) {\n      // Update user record on json-server\n      return this.http.put(`${this.apiUrl}/users/${user.id}`, user);\n    }\n    getUserTypes() {\n      return this.http.get(`${this.apiUrl}/userTypes`);\n    }\n    getClientTypes() {\n      return this.http.get(`${this.apiUrl}/clientTypes`);\n    }\n    getInvestorTypes() {\n      return this.http.get(`${this.apiUrl}/investorTypes`);\n    }\n    getMinistries() {\n      return this.http.get(`${this.apiUrl}/ministries`);\n    }\n    getStructures() {\n      return this.http.get(`${this.apiUrl}/structures`);\n    }\n    getCertifications() {\n      return this.http.get(`${this.apiUrl}/certifications`);\n    }\n    getTestUsers() {\n      return this.http.get(`${this.apiUrl}/users`);\n    }\n    authenticateUser(telephone, password) {\n      // First check localStorage for registered users\n      const registeredUsers = this.getRegisteredUsersFromStorage();\n      const normalizedPhone = telephone.replace(/^(\\+221|221)/, '');\n      // Check in registered users first\n      const registeredUser = registeredUsers.find(u => {\n        const userPhone = u.phone.replace(/^(\\+221|221)/, '');\n        return userPhone === normalizedPhone && u.password === password;\n      });\n      if (registeredUser) {\n        return of(registeredUser);\n      }\n      // If not found, check test users from JSON\n      return this.getTestUsers().pipe(map(users => {\n        const user = users.find(u => {\n          const userPhone = u.phone.replace(/^(\\+221|221)/, '');\n          return userPhone === normalizedPhone && u.password === password;\n        });\n        return user || null;\n      }));\n    }\n    registerUser(userData) {\n      // Normalize phone number\n      const normalizedPhone = userData.telephone.replace(/^(\\+221|221)/, '');\n      // Check if user already exists\n      return this.getTestUsers().pipe(map(existingUsers => {\n        const existingUser = existingUsers.find(u => {\n          const userPhone = u.phone.replace(/^(\\+221|221)/, '');\n          return userPhone === normalizedPhone;\n        });\n        if (existingUser) {\n          return {\n            success: false,\n            error: 'Un compte avec ce numéro de téléphone existe déjà'\n          };\n        }\n        // Create new user\n        const newUser = {\n          id: `user-${Date.now()}`,\n          email: userData.email || '',\n          password: userData.password,\n          userType: userData.userType.id,\n          firstName: userData.prenom,\n          lastName: userData.nom,\n          phone: userData.telephone,\n          region: userData.region || undefined,\n          department: userData.departement || userData.department || undefined,\n          village: userData.village || undefined,\n          clientType: userData.clientType || undefined,\n          investorType: userData.investorType || undefined,\n          investmentAmount: userData.montantInvestissement || undefined,\n          professionalEmail: userData.emailPro || undefined,\n          structure: userData.structure || undefined,\n          interventionRegions: userData.regionsIntervention || undefined,\n          governmentId: userData.governmentId || undefined,\n          ministry: userData.ministry || undefined,\n          agentCode: userData.agentCode || undefined,\n          adminCode: userData.adminCode || undefined,\n          // New accounts start as pending validation by admin\n          isValidated: false,\n          validationStatus: 'pending',\n          bankAccount: undefined\n        };\n        // Save to json-server\n        this.http.post(`${this.apiUrl}/users`, newUser).subscribe({\n          next: savedUser => {\n            console.log('User registered successfully:', savedUser);\n          },\n          error: error => {\n            console.error('Error saving user:', error);\n          }\n        });\n        return {\n          success: true,\n          user: newUser\n        };\n      }));\n    }\n    getRegisteredUsersFromStorage() {\n      const stored = localStorage.getItem('registeredUsers');\n      return stored ? JSON.parse(stored) : [];\n    }\n    getDepartementsByRegion(regionId) {\n      return this.getRegions().pipe(map(regions => {\n        const region = regions.find(r => r.id === regionId);\n        return region ? region.departements : [];\n      }));\n    }\n    validateUserRegistration(userType, formData) {\n      return this.getUserTypes().pipe(map(userTypes => {\n        const type = userTypes.find(t => t.id === userType);\n        if (!type) {\n          return {\n            valid: false,\n            errors: ['Type d\\'utilisateur invalide']\n          };\n        }\n        const errors = [];\n        // Validation des champs requis\n        type.requiredFields.forEach(field => {\n          if (!formData[field]) {\n            errors.push(`Le champ ${field} est requis`);\n          }\n        });\n        // Validations spécifiques\n        if (userType === 'agriculteur') {\n          if (!formData.region) errors.push('La région est requise');\n          if (!formData.departement) errors.push('Le département est requis');\n          if (!formData.village) errors.push('Le village est requis');\n        }\n        if (userType === 'client') {\n          if (!formData.clientType) errors.push('Le type de client est requis');\n        }\n        if (userType === 'investisseur') {\n          if (!formData.email || !this.isValidEmail(formData.email)) {\n            errors.push('Email invalide');\n          }\n          if (!formData.investorType) errors.push('Le type d\\'investisseur est requis');\n          if (!formData.montantInvestissement || formData.montantInvestissement < 100000) {\n            errors.push('Montant minimum: 100 000 FCFA');\n          }\n        }\n        if (userType === 'agronome') {\n          if (!formData.emailPro || !this.isValidEmail(formData.emailPro)) {\n            errors.push('Email professionnel invalide');\n          }\n          if (!formData.structure) errors.push('La structure est requise');\n          if (!formData.regionsIntervention || formData.regionsIntervention.length === 0) {\n            errors.push('Au moins une région d\\'intervention requise');\n          }\n        }\n        return {\n          valid: errors.length === 0,\n          errors\n        };\n      }));\n    }\n    isValidEmail(email) {\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      return emailRegex.test(email);\n    }\n    static {\n      this.ɵfac = function DataService_Factory(t) {\n        return new (t || DataService)(i0.ɵɵinject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: DataService,\n        factory: DataService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return DataService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}