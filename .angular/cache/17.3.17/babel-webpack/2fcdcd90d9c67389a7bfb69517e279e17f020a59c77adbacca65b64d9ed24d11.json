{"ast":null,"code":"import _asyncToGenerator from \"/home/bachir-uchiwa/Bureau/projet3D/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { RouterModule } from '@angular/router';\nimport { HeaderComponent } from '../../components/header/header.component';\nimport { FooterComponent } from '../../components/footer/footer.component';\nimport { ReactiveFormsModule, FormsModule, Validators } from '@angular/forms';\nlet DashboardAgriculteurComponent = class DashboardAgriculteurComponent {\n  constructor(dataService, fb) {\n    this.dataService = dataService;\n    this.fb = fb;\n    // Data\n    this.products = [];\n    this.seeds = [];\n    this.seedOrderQty = {};\n    this.alerts = [];\n    this.currentUser = null;\n    this.uploadedImageCount = 0;\n    this.selectedImages = [];\n    this.cameraActive = false;\n    this.stream = null;\n  }\n  ngOnInit() {\n    const raw = localStorage.getItem('currentUser');\n    this.currentUser = raw ? JSON.parse(raw) : null;\n    // Initialize forms\n    this.productForm = this.fb.group({\n      titre: ['', Validators.required],\n      description: ['', Validators.required],\n      categorie: ['', Validators.required],\n      quantite: ['', [Validators.required, Validators.min(0)]],\n      quantiteMinimale: ['', [Validators.required, Validators.min(0)]],\n      // 'prix' removed from form: we compute total price from quantite * prixParUnite\n      prixParUnite: ['', [Validators.required, Validators.min(0)]],\n      unite: ['', Validators.required],\n      localisation: ['', Validators.required]\n    });\n    this.bankForm = this.fb.group({\n      bankName: [''],\n      accountNumber: ['']\n    });\n    this.loadInitial();\n  }\n  loadInitial() {\n    if (!this.currentUser) return;\n    // Load user's products\n    this.dataService.getProductsByUser(this.currentUser.id).subscribe(list => this.products = list || []);\n    // Load seeds catalog\n    this.dataService.getSeedsCatalog().subscribe(list => {\n      this.seeds = list || [];\n      this.seeds.forEach(s => this.seedOrderQty[s.id] = 1);\n    });\n    // Load alerts filtered by region\n    if (this.currentUser.region) {\n      this.dataService.getAlertsByRegion(this.currentUser.region).subscribe(list => this.alerts = list || []);\n    }\n    // Bank info prefill\n    if (this.currentUser.bankAccount) {\n      this.bankForm.patchValue(this.currentUser.bankAccount);\n    }\n  }\n  // Handle image file selection\n  onImagesSelected(event) {\n    this.selectedImages = Array.from(event.target.files || []);\n    this.uploadedImageCount = this.selectedImages.length;\n  }\n  // Start camera\n  startCamera() {\n    this.cameraActive = true;\n    navigator.mediaDevices.getUserMedia({\n      video: {\n        facingMode: 'environment'\n      }\n    }).then(mediaStream => {\n      this.stream = mediaStream;\n      setTimeout(() => {\n        const video = document.getElementById('cameraVideo');\n        if (video) video.srcObject = mediaStream;\n      }, 100);\n    }).catch(err => {\n      console.error('Camera error:', err);\n      alert('Erreur d\\'accès à la caméra');\n      this.cameraActive = false;\n    });\n  }\n  // Capture photo from camera\n  capturePhoto() {\n    const video = document.getElementById('cameraVideo');\n    const canvas = document.getElementById('cameraCanvas');\n    if (!video || !canvas) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    canvas.width = video.videoWidth;\n    canvas.height = video.videoHeight;\n    ctx.drawImage(video, 0, 0);\n    canvas.toBlob(blob => {\n      if (blob) {\n        const file = new File([blob], `photo-${Date.now()}.jpg`, {\n          type: 'image/jpeg'\n        });\n        this.selectedImages.push(file);\n        this.uploadedImageCount = this.selectedImages.length;\n      }\n    }, 'image/jpeg', 0.95);\n  }\n  // Stop camera\n  stopCamera() {\n    this.cameraActive = false;\n    if (this.stream) {\n      this.stream.getTracks().forEach(track => track.stop());\n      this.stream = null;\n    }\n  }\n  // Publish product\n  publishProduct() {\n    var _this = this;\n    if (!this.productForm.valid || !this.currentUser) {\n      // Identify which controls are invalid to help debugging\n      const invalid = Object.keys(this.productForm.controls).filter(k => this.productForm.get(k)?.invalid);\n      console.warn('Product form invalid controls:', invalid);\n      const names = invalid.length ? invalid.join(', ') : 'inconnus';\n      alert('Veuillez remplir tous les champs obligatoires. Champs invalides: ' + names);\n      return;\n    }\n    // Convert images to base64 then upload them to Cloudinary via the upload server\n    this.convertImagesToBase64(this.selectedImages).then(/*#__PURE__*/function () {\n      var _ref = _asyncToGenerator(function* (base64Images) {\n        // upload to our small upload server\n        try {\n          let uploadedUrls = [];\n          if (base64Images.length) {\n            const resp = yield fetch('http://localhost:4201/upload-images', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({\n                images: base64Images\n              })\n            });\n            if (!resp.ok) {\n              const txt = yield resp.text();\n              console.error('Upload server error:', resp.status, txt);\n              alert('Erreur lors de l\\'upload des images');\n              return;\n            }\n            const json = yield resp.json();\n            uploadedUrls = (json.uploaded || []).map(u => u.url);\n          }\n          // compute total price from quantity and price per unit\n          const q = parseFloat(_this.productForm.value.quantite) || 0;\n          const ppu = parseFloat(_this.productForm.value.prixParUnite) || 0;\n          const totalPrice = q * ppu;\n          const product = {\n            id: `prod-${Date.now()}`,\n            agriculteurId: _this.currentUser.id,\n            titre: _this.productForm.value.titre,\n            description: _this.productForm.value.description,\n            categorie: _this.productForm.value.categorie,\n            quantite: q,\n            quantiteMinimale: parseFloat(_this.productForm.value.quantiteMinimale),\n            prix: totalPrice,\n            prixParUnite: ppu,\n            unite: _this.productForm.value.unite,\n            localisation: _this.productForm.value.localisation,\n            images: uploadedUrls,\n            statutValidation: 'en_attente',\n            statutDisponibilite: 'disponible',\n            datePublication: new Date().toISOString(),\n            dateMaj: new Date().toISOString()\n          };\n          _this.dataService.createProduct(product).subscribe({\n            next: created => {\n              _this.products.unshift(created);\n              alert('Produit publié — en attente de validation');\n              _this.resetProductForm();\n            },\n            error: err => {\n              console.error('Error publishing product', err);\n              alert('Erreur lors de la publication du produit');\n            }\n          });\n        } catch (err) {\n          console.error('Image upload failed', err);\n          alert('Échec lors de l\\'upload des images');\n        }\n      });\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }());\n  }\n  // Reset product form and image selection\n  resetProductForm() {\n    this.productForm.reset();\n    this.selectedImages = [];\n    this.uploadedImageCount = 0;\n    this.stopCamera();\n  }\n  // Convert files to base64\n  convertImagesToBase64(files) {\n    return Promise.all(files.map(file => {\n      return new Promise(resolve => {\n        const reader = new FileReader();\n        reader.onload = () => {\n          resolve(reader.result);\n        };\n        reader.readAsDataURL(file);\n      });\n    }));\n  }\n  // Bank account save\n  saveBankAccount() {\n    if (!this.currentUser) return;\n    const bank = this.bankForm.value;\n    const payload = {\n      bankName: bank.bankName || '',\n      accountNumber: bank.accountNumber || ''\n    };\n    this.dataService.updateUserBankAccount(this.currentUser.id, payload).subscribe({\n      next: u => {\n        this.currentUser = u;\n        localStorage.setItem('currentUser', JSON.stringify(u));\n        alert('Compte bancaire enregistré');\n      },\n      error: err => {\n        console.error(err);\n        alert('Erreur lors de l\\'enregistrement');\n      }\n    });\n  }\n  // Order seed\n  orderSeed(seed) {\n    if (!this.currentUser) return;\n    const qty = this.seedOrderQty[seed.id] || 1;\n    const order = {\n      id: `order-${Date.now()}`,\n      userId: this.currentUser.id,\n      seedId: seed.id,\n      seedName: seed.name,\n      quantity: qty,\n      total: (seed.price || 0) * qty,\n      status: 'paid',\n      createdAt: new Date().toISOString()\n    };\n    this.dataService.createSeedOrder(order).subscribe({\n      next: res => {\n        alert(`Commande passée: ${order.seedName} x${qty}`);\n      },\n      error: err => {\n        console.error(err);\n        alert('Erreur lors de la commande');\n      }\n    });\n  }\n};\nDashboardAgriculteurComponent = __decorate([Component({\n  selector: 'app-dashboard-agriculteur',\n  standalone: true,\n  imports: [CommonModule, RouterModule, HeaderComponent, FooterComponent, ReactiveFormsModule, FormsModule],\n  templateUrl: './dashboard-agriculteur.component.html',\n  styleUrls: ['./dashboard-agriculteur.component.css']\n})], DashboardAgriculteurComponent);\nexport { DashboardAgriculteurComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}